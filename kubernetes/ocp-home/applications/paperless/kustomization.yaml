apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: paperless
resources:
  - secret.yaml
  - pv.yaml
  - pvc.yaml
  - valkey.yaml

patches:
- path: deployment-patch.yaml

helmCharts:
- name: paperless
  includeCRDs: true
  version: 8.8.3
  repo: https://k8s-at-home.com/charts/
  releaseName: paperless
  namespace: paperless
  valuesInline:
    image:
      # https://github.com/paperless-ngx/paperless-ngx/pkgs/container/paperless-ngx/versions?filters%5Bversion_type%5D=tagged
      tag: 2.18.4
      pullPolicy: IfNotPresent
    env:
      PAPERLESS_TIME_ZONE: America/New_York
      PAPERLESS_OCR_LANGUAGE: eng
      PAPERLESS_CONSUMER_POLLING: 60
      PAPERLESS_REDIS: redis://paperless-valkey:6379
      PAPERLESS_OCR_USER_ARGS: '{"invalidate_digital_signatures": true}'  # https://github.com/paperless-ngx/paperless-ngx/discussions/4047#discussion-5544405
      PAPERLESS_URL: https://paperless.apps.ocp-home.rh-lab.morey.tech  # Set https explicitly, defaults to http due to no TLS on ingress config.
    ingress:
      main:
        enabled: true
        ingressClassName: openshift-default
        annotations:
          # Use default openshift router *.apps certificate.
          route.openshift.io/termination: edge
        hosts:
          - host: paperless.apps.ocp-home.rh-lab.morey.tech
            paths:
            - path: /
              pathType: Prefix
    # Persistence is disabled here because the helm chart creates separate volume
    # definitions for each persistence entry, which causes mount issues when they
    # all reference the same PVC. Instead, deployment-patch.yaml defines a single
    # volume with multiple subPath mounts.
    persistence:
      consume:
        enabled: false
      data:
        enabled: false
      media:
        enabled: false
      export:
        enabled: false
    redis:
      enabled: false