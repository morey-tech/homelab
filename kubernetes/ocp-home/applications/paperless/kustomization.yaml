apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: paperless
resources:
  - secret.yaml
  - pv.yaml
  - pvc.yaml

patches:
- path: deployment-patch.yaml

helmCharts:
- name: paperless
  includeCRDs: true
  version: 8.8.3
  repo: https://k8s-at-home.com/charts/
  releaseName: paperless
  namespace: paperless
  valuesInline:
    image:
      # https://github.com/paperless-ngx/paperless-ngx/pkgs/container/paperless-ngx/versions?filters%5Bversion_type%5D=tagged
      tag: 2.18.4
      pullPolicy: IfNotPresent
    env:
      PAPERLESS_TIME_ZONE: America/New_York
      PAPERLESS_OCR_LANGUAGE: eng
      PAPERLESS_CONSUMER_POLLING: 60
      PAPERLESS_REDIS: redis://paperless-redis-headless:6379
      PAPERLESS_OCR_USER_ARGS: '{"invalidate_digital_signatures": true}'  # https://github.com/paperless-ngx/paperless-ngx/discussions/4047#discussion-5544405
    ingress:
      main:
        enabled: true
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - host: paperless.apps.ocp-home.rh-lab.morey.tech
            paths:
            - path: /
              pathType: Prefix
        tls:
        - secretName: paperless.apps.ocp-home.rh-lab.morey.tech
          hosts:
          - paperless.apps.ocp-home.rh-lab.morey.tech
    # Persistence is disabled here because the helm chart creates separate volume
    # definitions for each persistence entry, which causes mount issues when they
    # all reference the same PVC. Instead, deployment-patch.yaml defines a single
    # volume with multiple subPath mounts.
    persistence:
      consume:
        enabled: false
      data:
        enabled: false
      media:
        enabled: false
      export:
        enabled: false
    redis:
      enabled: true
      image:
        pullPolicy: IfNotPresent
      architecture: standalone
      auth:
        enabled: false
      master:
        persistence:
          enabled: false