apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: unifi

resources:
  - postgres-secret.yaml
  - postgres.yaml
  - ferretdb.yaml

helmCharts:
- name: unifi
  includeCRDs: true
  version: 5.1.2
  repo: https://k8s-at-home.com/charts/
  releaseName: unifi
  namespace: unifi
  valuesInline:
    image:
      pullPolicy: IfNotPresent
      tag: v8.6.9
      repository: jacobalberty/unifi

    # # Fixed discovery on local network.
    # hostNetwork: false

    service:
      main:
        type: LoadBalancer
        annotations:
          metallb.universe.tf/address-pool: ocp-home-static-address-pool
          metallb.universe.tf/allow-shared-ip: "10.10.0.4"
          metallb.universe.tf/loadBalancerIPs: 10.10.0.4
        ports:
          http:
            port: 8443
            protocol: HTTPS
          controller:
            enabled: true
            port: 8080
            protocol: TCP
          speedtest:
            enabled: true
            port: 6789
            protocol: TCP
          # Moved to UDP service.
          stun:
            enabled: false
          syslog:
            enabled: false
          discovery:
            enabled: false
      udp:
        enabled: true
        type: LoadBalancer
        annotations:
          metallb.universe.tf/address-pool: ocp-home-static-address-pool
          metallb.universe.tf/allow-shared-ip: "10.10.0.4"
          metallb.universe.tf/loadBalancerIPs: 10.10.0.4
        ports:
          stun:
            enabled: true
            port: 3478
            protocol: UDP
          syslog:
            enabled: true
            port: 5514
            protocol: UDP
          discovery:
            enabled: true
            port: 10001
            protocol: UDP
          discovery-l2:
            enabled: true
            port: 1900
            protocol: UDP

    ingress:
      main:
        enabled: true
        ingressClassName: openshift-default
        annotations:
          # Use default openshift router *.apps certificate.
          route.openshift.io/termination: edge
        hosts:
          - host: unifi.apps.ocp-home.rh-lab.morey.tech
            paths:
            - path: /
              pathType: Prefix
    persistence:
      data:
        enabled: true
        size: 2147483648
        accessMode: ReadWriteOnce
        mountPath: /unifi

    resources:
      requests:
        cpu: 100m
        memory: 1024Mi
      limits:
        cpu: 1000m
        memory: 2048Mi

    # Disable Bitnami MongoDB subchart - using FerretDB + CloudNativePG instead
    mongodb:
      enabled: false

    env:
      # FerretDB provides MongoDB wire protocol over PostgreSQL (ferretdb.yaml)
      DB_MONGO_URI: mongodb://ferretdb.unifi.svc.cluster.local:27017/unifi
      DB_NAME: unifi