# Base development container extending Red Hat Universal Developer Image
# Provides Claude CLI and GitHub CLI for AI-assisted development
# Designed for OpenShift DevSpaces and local VS Code devcontainer usage
#
# UDI already includes: kubectl, oc, helm, kustomize, terraform, kubectx, kubens
FROM quay.io/devfile/universal-developer-image:ubi9-latest

LABEL org.opencontainers.image.title="devspace-base"
LABEL org.opencontainers.image.description="Base development container with Claude CLI and GitHub CLI"
LABEL org.opencontainers.image.source="https://github.com/morey-tech/homelab"

ARG TARGETARCH

USER root

# Install GitHub CLI
# UDI may or may not include gh CLI, so install it explicitly to be sure
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -fsSL https://cli.github.com/packages/rpm/gh-cli.repo | tee /etc/yum.repos.d/gh-cli.repo && \
    dnf install -y gh && \
    dnf clean all

# Install browser dependencies for Puppeteer/Chromium
# Required by VSCode extensions that use headless browsers (e.g., Roo Code)
RUN dnf install -y \
    nspr \
    nss \
    alsa-lib \
    atk \
    cups-libs \
    gtk3 \
    pango \
    libX11 \
    libX11-xcb \
    libXcomposite \
    libXcursor \
    libXdamage \
    libXext \
    libXfixes \
    libXi \
    libXrandr \
    libXrender \
    libXScrnSaver \
    libXtst \
    fontconfig \
    urw-base35-fonts \
    && dnf update nss -y \
    && dnf clean all

# Install Claude CLI
# The install script auto-detects architecture and installs to /home/user/.local/bin/
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install GitHub CLI auto-authentication script
COPY gh-auth-init.sh /usr/local/bin/gh-auth-init.sh
RUN chmod +x /usr/local/bin/gh-auth-init.sh && \
    mkdir -p /home/user/.bashrc.d && \
    ln -s /usr/local/bin/gh-auth-init.sh /home/user/.bashrc.d/00-gh-auth.sh && \
    chown -R user:user /home/user/.bashrc.d

# Ensure .bashrc sources .bashrc.d scripts
RUN grep -q '.bashrc.d' /home/user/.bashrc || \
    echo -e '\n# Source additional shell initialization scripts\nif [ -d ~/.bashrc.d ]; then\n    for rc in ~/.bashrc.d/*; do\n        [ -f "$rc" ] && . "$rc"\n    done\nfi' >> /home/user/.bashrc

# Ensure CLIs are in PATH
ENV PATH="/home/user/.local/bin:${PATH}"

# Verify installations
RUN gh --version && \
    (claude --version || echo "Warning: Claude CLI may not be installed correctly")

USER user
WORKDIR /projects
