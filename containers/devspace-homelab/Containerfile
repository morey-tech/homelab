# DevSpaces-compatible development container
# Extends devspace-base which includes Claude CLI and GitHub CLI with auto-authentication
# Maintains OpenShift DevSpaces compatibility while working with local VS Code devcontainer
#
# Base image includes: kubectl, oc, helm, kustomize, terraform, kubectx, kubens, gh, claude
FROM ghcr.io/morey-tech/homelab/devspace-base:sha-dad4013

LABEL org.opencontainers.image.title="devspace-homelab"
LABEL org.opencontainers.image.description="Development container for homelab infrastructure"
LABEL org.opencontainers.image.source="https://github.com/morey-tech/homelab"

ARG TARGETARCH

USER root

# Rename 'user' to 'morey-tech' and relocate home directory
# This maintains compatibility with local devcontainer config while working with DevSpaces
RUN usermod -l morey-tech user \
    && groupmod -n morey-tech user \
    && usermod -d /home/morey-tech -m morey-tech \
    && ln -s /home/morey-tech /home/user

# Set environment for both local and DevSpaces usage
ENV HOME=/home/morey-tech
ENV USER_NAME=morey-tech
ENV PATH="/home/morey-tech/.local/bin:${PATH}"

# The gh-auth-init.sh symlink is inherited from devspace-base when home directory is moved
# Just ensure correct permissions for OpenShift arbitrary UID support
RUN chown -R morey-tech:0 /home/morey-tech/.bashrc.d && \
    chmod -R g=u /home/morey-tech/.bashrc.d

# Ensure permissions for OpenShift arbitrary UID support
RUN chgrp -R 0 /home/morey-tech \
    && chmod -R g=u /etc/passwd /etc/group /home/morey-tech

# Install additional tools not included in UDI

# konfig - kubectl config management
ENV KONFIG_VERSION=v0.2.6
RUN curl -Lo konfig https://github.com/corneliusweig/konfig/raw/${KONFIG_VERSION}/konfig \
    && chmod +x konfig \
    && mv konfig /usr/local/bin/

# kubeneat - clean kubectl output
ENV KUBENEAT_VERSION=v2.0.4
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -Lo kubectl-neat.tar.gz https://github.com/itaysk/kubectl-neat/releases/download/${KUBENEAT_VERSION}/kubectl-neat_linux_${ARCH}.tar.gz \
    && tar -xvzf kubectl-neat.tar.gz kubectl-neat \
    && mv kubectl-neat /usr/local/bin/kubeneat \
    && chmod 755 /usr/local/bin/kubeneat \
    && rm -f kubectl-neat.tar.gz

# kubeseal - sealed secrets CLI
ENV KUBESEAL_VERSION=0.18.5
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -Lo kubeseal.tar.gz https://github.com/bitnami-labs/sealed-secrets/releases/download/v${KUBESEAL_VERSION}/kubeseal-${KUBESEAL_VERSION}-linux-${ARCH}.tar.gz \
    && tar -xvzf kubeseal.tar.gz kubeseal \
    && mv kubeseal /usr/local/bin/ \
    && chmod 755 /usr/local/bin/kubeseal \
    && rm -f kubeseal.tar.gz

# argocd CLI
ENV ARGOCD_VERSION=v2.8.4
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-${ARCH} \
    && chmod +x /usr/local/bin/argocd

# k9s - Kubernetes TUI
ENV K9S_VERSION=v0.30.8
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -Lo k9s.tar.gz https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_${ARCH}.tar.gz \
    && tar -xvzf k9s.tar.gz k9s \
    && mv k9s /usr/local/bin/ \
    && chmod 755 /usr/local/bin/k9s \
    && rm -f k9s.tar.gz

# vcluster - virtual clusters
ENV VCLUSTER_VERSION=v0.20.0-beta.1
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -L -o vcluster https://github.com/loft-sh/vcluster/releases/download/${VCLUSTER_VERSION}/vcluster-linux-${ARCH} \
    && install -c -m 0755 vcluster /usr/local/bin \
    && rm -f vcluster

# OCM CLI - OpenShift Cluster Manager
ENV OCM_VERSION=v1.0.10
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -Lo /usr/local/bin/ocm https://github.com/openshift-online/ocm-cli/releases/download/${OCM_VERSION}/ocm-linux-${ARCH} \
    && chmod +x /usr/local/bin/ocm

# Velero CLI - Backup and restore for Kubernetes
ENV VELERO_VERSION=v1.14.1
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -sL -o velero.tar.gz https://github.com/vmware-tanzu/velero/releases/download/${VELERO_VERSION}/velero-${VELERO_VERSION}-linux-${ARCH}.tar.gz \
    && tar -xzf velero.tar.gz velero-${VELERO_VERSION}-linux-${ARCH}/velero \
    && mv velero-${VELERO_VERSION}-linux-${ARCH}/velero /usr/local/bin/ \
    && chmod 755 /usr/local/bin/velero \
    && rm -rf velero.tar.gz velero-${VELERO_VERSION}-linux-${ARCH}

# Install Python 3.12 for modern package compatibility (ansible 13.x requires Python 3.12+)
RUN dnf install -y python3.12 python3.12-pip && dnf clean all
COPY requirements.txt /tmp/requirements.txt
RUN python3.12 -m pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm /tmp/requirements.txt
# Create symlink so ansible and related tools are in PATH
RUN ln -sf /usr/bin/python3.12 /usr/local/bin/python3

# Add custom bash aliases
COPY .bash_aliases /home/morey-tech/.bash_aliases
RUN chown morey-tech:0 /home/morey-tech/.bash_aliases \
    && chmod g=u /home/morey-tech/.bash_aliases

# Add CLI completions
RUN echo 'source <(argocd completion bash)' >> /etc/bash_completion.d/argocd \
    && echo 'alias k="kubectl"' >> /home/morey-tech/.bashrc \
    && echo 'complete -F __start_kubectl k' >> /home/morey-tech/.bashrc

# Ensure .kube directory exists with proper permissions
RUN mkdir -p /home/morey-tech/.kube \
    && touch /home/morey-tech/.kube/config \
    && chown -R morey-tech:0 /home/morey-tech/.kube \
    && chmod -R g=u /home/morey-tech/.kube

# Switch back to non-root user
USER morey-tech
WORKDIR /projects
