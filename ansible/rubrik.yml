---
- name: Prepare rubrik nodes for K8s
  hosts:
    - rubrik
  become: true

  tasks:
    - name: Install apt packages
      ansible.builtin.apt:
        name:
          - nfs-common
        state: present
        update_cache: true

    # sudo snap install microk8s --classic
    - name: Install snap packages microk8s and related tools
      community.general.snap:
        name:
          - microk8s
          - jq
          - kubectl
        classic: true

    # sudo usermod -a -G microk8s {{ ansible_user }}
    - name: Apending microk8s group to user {{ ansible_user }}
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: microk8s  # Add the user to a group
        append: true        # Add the user to the group without removing from other groups

    # sudo chown -f -R {{ ansible_user }} ~/.kube
    - name: Set ownership of ~/.kube for {{ ansible_user }}
      ansible.builtin.file:
        path: ~/.kube
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true  # Equivalent to -R
        force: true    # Equivalent to -f
        state: directory  # Ensure it's treated as a directory
